<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>上传两张照片，生成 10 张场景 PDF 预览</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "PingFang SC", "Microsoft Yahei", sans-serif;
           max-width: 820px; margin: 24px auto; padding: 0 16px; color:#222; }
    h1 { font-size: 28px; line-height: 1.3; margin: 0 0 8px; }
    small { color:#666; }
    label { display:block; margin:16px 0 8px; font-weight:600; }
    input[type="file"] { display:block; margin: 6px 0 12px; }
    input[type="email"], input[type="text"] { width:100%; max-width:520px; padding:10px 12px; border:1px solid #ddd; border-radius:8px; }
    button { padding:10px 16px; border:0; border-radius:10px; background:#111; color:#fff; cursor:pointer; }
    button[disabled] { opacity:.55; cursor:not-allowed; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .muted { color:#666; }
    .ok { color:#0a7f2e; }
    .err { color:#c00; }
    .card { border:1px solid #eee; border-radius:12px; padding:16px; margin-top:18px; }
    .kvs { margin-top:8px; color:#333; }
    .kvs b { margin-right:8px; }
  </style>
</head>
<body>
  <h1>上传两张照片，生成 10 张场景 PDF 预览</h1>
  <small>每个邮箱最多可免费使用 <b>10</b> 次（预览带水印）</small>

  <div class="card">
    <label>邮箱：</label>
    <div class="row">
      <input id="email" type="email" placeholder="you@example.com" />
      <button id="getLinkBtn">获取上传链接</button>
    </div>
    <div class="muted" style="margin-top:6px;">点击后本页会自动携带 <code>?token=...</code>。</div>
    <div class="kvs" id="tokenLine" style="display:none;"></div>
  </div>

  <div class="card">
    <div class="row">
      <div>已用：<b id="used">0</b> 次，剩余：<b id="remain">10</b> / 10</div>
      <div id="quotaNote" class="muted"></div>
    </div>
  </div>

  <div class="card">
    <label>源脸 1：</label>
    <input id="source" type="file" accept="image/*" />

    <label>源脸 2：</label>
    <input id="target" type="file" accept="image/*" />

    <div class="row" style="margin-top:8px;">
      <button id="goBtn">生成带水印 PDF</button>
      <div id="status" class="muted"></div>
    </div>
  </div>

  <script>
    // 后端基址：同域部署可用 location.origin；也可手动写死你的域名
    const API_BASE = location.origin;

    // 从 URL 取 token（或点击“获取上传链接”后写入）
    const params = new URLSearchParams(location.search);
    let token = params.get("token") || "";

    // DOM refs
    const $email = document.getElementById("email");
    const $getLinkBtn = document.getElementById("getLinkBtn");
    const $tokenLine = document.getElementById("tokenLine");

    const $used = document.getElementById("used");
    const $remain = document.getElementById("remain");
    const $quotaNote = document.getElementById("quotaNote");

    const $source = document.getElementById("source");
    const $target = document.getElementById("target");
    const $goBtn = document.getElementById("goBtn");
    const $status = document.getElementById("status");

    // ===== 工具 =====
    function setBusy(busy) {
      $getLinkBtn.disabled = !!busy;
      $goBtn.disabled = !!busy || $goBtn.dataset.locked === "1";
    }
    function lockGenerate(lock) {
      $goBtn.dataset.locked = lock ? "1" : "0";
      if (lock) $goBtn.setAttribute("disabled", "disabled");
      else $goBtn.removeAttribute("disabled");
    }
    function showTokenLine() {
      if (!token) { $tokenLine.style.display = "none"; return; }
      $tokenLine.style.display = "block";
      $tokenLine.innerHTML = `<b>已携带 token：</b><code class="muted">${token.slice(0, 24)}...</code>`;
    }

    // ===== 1) 通过邮箱获取上传链接（MVP：后端返回 link） =====
    async function getUploadLink() {
      try {
        setBusy(true);
        $status.textContent = "正在请求链接…";
        const res = await fetch(`${API_BASE}/api/request-magic-link`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email: $email.value.trim() })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || "请求失败");

        // 解析新 token 并改写地址栏（不刷新）
        const u = new URL(data.link);
        token = (new URLSearchParams(u.search)).get("token") || "";
        const now = new URL(location.href);
        now.searchParams.set("token", token);
        history.replaceState(null, "", now);
        showTokenLine();

        $status.textContent = "已获取 token，可以上传生成。";
        // 顺手刷新配额展示
        await refreshQuota();
      } catch (e) {
        $status.textContent = "获取链接失败：" + e.message;
      } finally {
        setBusy(false);
      }
    }

    // ===== 2) 刷新配额（/api/check-free） =====
    async function refreshQuota() {
      if (!token) { lockGenerate(true); return; }
      try {
        const res = await fetch(`${API_BASE}/api/check-free?token=${encodeURIComponent(token)}`);
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error(data?.error || "查询失败");

        const used = Number(data.used || 0);
        const remain = Math.max(0, 10 - used);
        $used.textContent = used;
        $remain.textContent = remain;
        $quotaNote.textContent = remain <= 0 ? "免费配额已用完，如需继续请升级为付费。" : "";
        lockGenerate(remain <= 0);
      } catch (e) {
        // 查询失败不阻塞使用（若你想严格限制，可在失败时 lockGenerate(true)）
        console.warn("check-free fail:", e.message);
      }
    }

    // ===== 3) 生成 PDF（faceswap-batch 直接返回 PDF） =====
    async function generatePDF() {
      try {
        if (!token) return alert("缺少 token，请先获取上传链接或使用带 ?token=... 的地址打开本页");
        if (!$source.files[0] || !$target.files[0]) return alert("请先选择两张源脸图片");
        setBusy(true);
        $status.textContent = "正在生成…";

        const fd = new FormData();
        fd.append("source", $source.files[0]);
        fd.append("target", $target.files[0]);

        const res = await fetch(`${API_BASE}/api/faceswap-batch`, {
          method: "POST",
          headers: { Authorization: `Bearer ${token}` },
          body: fd
        });

        if (res.status === 403) {
          const j = await res.json().catch(()=>null);
          lockGenerate(true);
          throw new Error(j?.error || "免费次数已用完");
        }
        if (!res.ok) {
          const j = await res.json().catch(()=>null);
          throw new Error(j?.error || `生成失败（${res.status}）`);
        }

        // 打开 PDF 预览（被拦截则触发下载）
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const w = window.open(url, "_blank");
        if (!w) {
          const a = document.createElement("a");
          a.href = url;
          a.download = "faceswap-preview.pdf";
          a.click();
        }
        setTimeout(() => URL.revokeObjectURL(url), 10_000);

        $status.textContent = "PDF 已生成。";
        // 再刷新一次配额显示
        await refreshQuota();
      } catch (e) {
        $status.textContent = "生成失败：" + e.message;
      } finally {
        setBusy(false);
      }
    }

    // 事件绑定
    document.getElementById("getLinkBtn").addEventListener("click", getUploadLink);
    document.getElementById("goBtn").addEventListener("click", generatePDF);

    // 首次加载：展示 token/查询配额
    showTokenLine();
    refreshQuota();
  </script>
</body>
</html>
